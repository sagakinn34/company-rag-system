import os
import chromadb
from sentence_transformers import SentenceTransformer
import logging

class VectorDBProcessor:
    def __init__(self, db_path="chroma_db"):
        """ChromaDBã‚’ä½¿ç”¨ã—ãŸãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‡¦ç†ã‚¯ãƒ©ã‚¹"""
        self.db_path = db_path
        
        # è»½é‡ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›´ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’å¤§å¹…å‰Šæ¸›ï¼‰
        print("ðŸ“¦ è»½é‡åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...")
        self.model = SentenceTransformer('intfloat/multilingual-e5-small')
        print("âœ… è»½é‡ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†")
        
        # ChromaDBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        self.client = chromadb.PersistentClient(path=db_path)
        
        # ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å–å¾—ã¾ãŸã¯ä½œæˆ
        try:
            self.collection = self.client.get_collection("company_documents")
            print(f"ðŸ“š æ—¢å­˜ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿: {self.collection.count()}ä»¶")
        except:
            self.collection = self.client.create_collection("company_documents")
            print("ðŸ“š æ–°è¦ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†")
    
    def add_document(self, document_data):
        """æ–‡æ›¸ã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ """
        try:
            # ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’å–å¾—
            content = document_data.get('content', '')
            if not content or len(content.strip()) == 0:
                print("âš ï¸ ç©ºã®æ–‡æ›¸ã‚’ã‚¹ã‚­ãƒƒãƒ—")
                return False
            
            # é•·ã™ãŽã‚‹æ–‡æ›¸ã¯åˆ‡ã‚Šè©®ï¼ˆãƒ¡ãƒ¢ãƒªå¯¾ç­–ï¼‰
            if len(content) > 2000:
                content = content[:2000] + "..."
            
            # åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
            embedding = self.model.encode(content).tolist()
            
            # æ–‡æ›¸IDç”Ÿæˆ
            doc_id = f"doc_{self.collection.count() + 1}"
            
            # ChromaDBã«è¿½åŠ 
            self.collection.add(
                documents=[content],
                embeddings=[embedding],
                metadatas=[{
                    'title': document_data.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'),
                    'source': document_data.get('source', 'unknown'),
                    'type': document_data.get('type', 'document')
                }],
                ids=[doc_id]
            )
            
            print(f"âœ… æ–‡æ›¸è¿½åŠ æˆåŠŸ: {document_data.get('title', 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')[:50]}...")
            return True
            
        except Exception as e:
            print(f"âŒ æ–‡æ›¸è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def search(self, query, n_results=5):
        """ã‚¯ã‚¨ãƒªã«åŸºã¥ã„ã¦é¡žä¼¼æ–‡æ›¸ã‚’æ¤œç´¢"""
        try:
            # ã‚¯ã‚¨ãƒªã®åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
            query_embedding = self.model.encode(query).tolist()
            
            # é¡žä¼¼æ–‡æ›¸ã‚’æ¤œç´¢
            results = self.collection.query(
                query_embeddings=[query_embedding],
                n_results=n_results
            )
            
            # çµæžœã‚’æ•´å½¢
            formatted_results = []
            for i, doc in enumerate(results['documents'][0]):
                formatted_results.append({
                    'content': doc,
                    'metadata': results['metadatas'][0][i],
                    'distance': results['distances'][0][i] if 'distances' in results else 0
                })
            
            print(f"ðŸ” æ¤œç´¢å®Œäº†: {len(formatted_results)}ä»¶ã®é–¢é€£æ–‡æ›¸ã‚’ç™ºè¦‹")
            return formatted_results
            
        except Exception as e:
            print(f"âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def get_stats(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—"""
        count = self.collection.count()
        return {
            'total_documents': count,
            'status': 'active' if count > 0 else 'empty'
        }

if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    processor = VectorDBProcessor()
    stats = processor.get_stats()
    print(f"ðŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ: {stats}")
    
    # ç°¡å˜ãªæ¤œç´¢ãƒ†ã‚¹ãƒˆ
    if stats['total_documents'] > 0:
        test_results = processor.search("ãƒ†ã‚¹ãƒˆ", n_results=2)
        print(f"ðŸ§ª æ¤œç´¢ãƒ†ã‚¹ãƒˆå®Œäº†: {len(test_results)}ä»¶")
